!function(){"use strict";var l={}.hasOwnProperty,u=[].slice;(function(){var t,o;if(null!=this.L)return this.OverlappingMarkerSpiderfier=((t=e.prototype).VERSION="0.2.6",o=2*Math.PI,t.keepSpiderfied=!1,t.nearbyDistance=20,t.circleSpiralSwitchover=9,t.circleFootSeparation=25,t.circleStartAngle=o/12,t.spiralFootSeparation=28,t.spiralLengthStart=11,t.spiralLengthFactor=5,t.legWeight=1.5,t.legColors={usual:"#222",highlighted:"#f00"},t.legStartCenter=!0,t.initMarkerArrays=function(){return this.markers=[],this.markerListeners=[]},t.addMarker=function(t){var e,r;return null!=t._oms||(t._oms=!0,r=this,e=function(){return r.spiderListener(t)},t.addEventListener("click",e),this.markerListeners.push(e),this.markers.push(t)),this},t.getMarkers=function(){return this.markers.slice(0)},t.removeMarker=function(t){var e,r;return null!=t._omsData&&this.unspiderfy(),(e=this.arrIndexOf(this.markers,t))<0||(r=this.markerListeners.splice(e,1)[0],t.removeEventListener("click",r),delete t._oms,this.markers.splice(e,1)),this},t.clearMarkers=function(){var t,e,r,i,n,s;for(this.unspiderfy(),t=e=0,r=(s=this.markers).length;e<r;t=++e)i=s[t],n=this.markerListeners[t],i.removeEventListener("click",n),delete i._oms;return this.initMarkerArrays(),this},t.addListener=function(t,e){var r;return(null!=(r=this.listeners)[t]?r[t]:r[t]=[]).push(e),this},t.removeListener=function(t,e){var r=this.arrIndexOf(this.listeners[t],e);return r<0||this.listeners[t].splice(r,1),this},t.clearListeners=function(t){return this.listeners[t]=[],this},t.trigger=function(){for(var t,e,r=arguments[0],i=2<=arguments.length?u.call(arguments,1):[],n=null!=(e=this.listeners[r])?e:[],s=[],a=0,h=n.length;a<h;a++)t=n[a],s.push(t.apply(null,i));return s},t.generatePtsCircle=function(t,e){for(var r,i,n=this.circleFootSeparation*(2+t)/o,s=o/t,a=[],h=i=0,l=t;0<=l?i<l:l<i;h=0<=l?++i:--i)r=this.circleStartAngle+h*s,a.push(new L.Point(e.x+n*Math.cos(r),e.y+n*Math.sin(r)));return a},t.generatePtsSpiral=function(t,e){for(var r,i,n=this.spiralLengthStart,s=0,a=[],h=r=0,l=t;0<=l?r<l:l<r;h=0<=l?++r:--r)s+=this.spiralFootSeparation/n+5e-4*h,i=new L.Point(e.x+n*Math.cos(s),e.y+n*Math.sin(s)),n+=o*this.spiralLengthFactor/s,a.push(i);return a},t.spiderListener=function(t){var e,r,i,n,s,a,h,l,o,u=null!=t._omsData;if(u&&this.keepSpiderfied||this.unspiderfy(),u)return this.trigger("click",t);for(a=[],h=[],l=this.nearbyDistance*this.nearbyDistance,s=this.map.latLngToLayerPoint(t.getLatLng()),e=0,r=(o=this.markers).length;e<r;e++)i=o[e],this.map.hasLayer(i)&&(n=this.map.latLngToLayerPoint(i.getLatLng()),this.ptDistanceSq(n,s)<l?a.push({marker:i,markerPt:n}):h.push(i));return 1===a.length?this.trigger("click",t):this.spiderfy(a,h)},t.makeHighlightListeners=function(t){return{highlight:function(){return t._omsData.leg.setStyle({color:r.legColors.highlighted})},unhighlight:(e=r=this,function(){return t._omsData.leg.setStyle({color:e.legColors.usual})})};var e,r},t.spiderfy=function(i,t){var e,n,s,a,h,l,o,u,g,c,r,f;return this.spiderfying=!0,r=i.length,e=this.ptAverage(function(){for(var t=[],e=0,r=i.length;e<r;e++)u=i[e],t.push(u.markerPt);return t}()),n=this.map.layerPointToLatLng(e),h=r>=this.circleSpiralSwitchover?this.generatePtsSpiral(r,e).reverse():this.generatePtsCircle(r,e),f=function(){for(var t=[],e=0,r=h.length;e<r;e++)a=h[e],s=this.map.layerPointToLatLng(a),c=this.minExtract(i,function(e){return function(t){return e.ptDistanceSq(t.markerPt,a)}}(this)),o=c.marker,l=new L.Polyline([this.legStartCenter?n:o.getLatLng(),s],{color:this.legColors.usual,weight:this.legWeight,interactive:!1}),this.map.addLayer(l),o._omsData={usualPosition:o.getLatLng(),leg:l},this.legColors.highlighted!==this.legColors.usual&&(g=this.makeHighlightListeners(o),o._omsData.highlightListeners=g,o.addEventListener("mouseover",g.highlight),o.addEventListener("mouseout",g.unhighlight)),o.setLatLng(s),o.setZIndexOffset(o.options.zIndexOffset+1e6),t.push(o);return t}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",f,t)},t.unspiderfy=function(t){var e,r,i,n,s,a,h;if(null==t&&(t=null),null==this.spiderfied)return this;for(this.unspiderfying=!0,h=[],s=[],e=0,r=(a=this.markers).length;e<r;e++)null!=(i=a[e])._omsData?(this.map.removeLayer(i._omsData.leg),i!==t&&i.setLatLng(i._omsData.usualPosition),i.setZIndexOffset(i.options.zIndexOffset-1e6),null!=(n=i._omsData.highlightListeners)&&(i.removeEventListener("mouseover",n.highlight),i.removeEventListener("mouseout",n.unhighlight)),delete i._omsData,h.push(i)):s.push(i);return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",h,s),this},t.ptDistanceSq=function(t,e){var r=t.x-e.x,i=t.y-e.y;return r*r+i*i},t.ptAverage=function(t){for(var e,r,i,n=i=0,s=0,a=t.length;s<a;s++)n+=(r=t[s]).x,i+=r.y;return e=t.length,new L.Point(n/e,i/e)},t.minExtract=function(t,e){for(var r,i,n,s,a=n=0,h=t.length;n<h;a=++n)s=e(t[a]),(null==r||s<i)&&(i=s,r=a);return t.splice(r,1)[0]},t.arrIndexOf=function(t,e){var r,i,n;if(null!=t.indexOf)return t.indexOf(e);for(r=i=0,n=t.length;i<n;r=++i)if(t[r]===e)return r;return-1},e);function e(t,e){var r,i,n,s,a,h;for(n in this.map=t,null==e&&(e={}),e)l.call(e,n)&&(h=e[n],this[n]=h);for(this.initMarkerArrays(),this.listeners={},i=0,s=(a=["click","zoomend"]).length;i<s;i++)r=a[i],this.map.addEventListener(r,function(t){return function(){return t.unspiderfy()}}(this))}}).call(window)}();
